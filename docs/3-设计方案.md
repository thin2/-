# 3. 设计方案

## 3.1 架构设计

### 3.1.1 整体架构

本项目采用**前后端分离**的架构模式，具体如下：

```
┌─────────────────┐
│   前端 (Vue.js)  │
│  - 页面渲染      │
│  - 用户交互      │
│  - API调用       │
└────────┬────────┘
         │ HTTP/JSON
         │
┌────────▼────────┐
│  后端 (Flask)    │
│  - 业务逻辑      │
│  - 数据验证      │
│  - API路由       │
└────────┬────────┘
         │
┌────────▼────────┐
│  数据库 (SQLite) │
│  - 数据存储      │
│  - 数据查询      │
└─────────────────┘
         │
┌────────▼────────┐
│  AI服务 (智谱AI) │
│  - 对话生成      │
│  - 流式输出      │
└─────────────────┘
```

### 3.1.2 技术选型

#### 前端技术栈
- **Vue.js 2.x**：渐进式JavaScript框架，用于构建用户界面
- **Element UI**：基于Vue 2.0的桌面端组件库，提供丰富的UI组件
- **ECharts**：百度开源的数据可视化库，用于图表展示
- **Axios**：基于Promise的HTTP客户端，用于API请求
- **原生JavaScript**：不使用构建工具，直接使用CDN引入

#### 后端技术栈
- **Flask 3.0+**：轻量级Python Web框架，灵活且易扩展
- **SQLAlchemy 3.0+**：Python ORM框架，简化数据库操作
- **PyJWT 2.8+**：JWT Token生成和验证
- **Werkzeug**：密码加密和安全工具
- **Requests**：HTTP库，用于调用AI API

#### 数据库
- **SQLite**：轻量级关系型数据库，适合单机部署
- **特点**：无需单独安装，数据存储在单个文件中

#### AI服务
- **智谱AI GLM-4.5-flash**：大语言模型API
- **特点**：支持流式输出，响应速度快

### 3.1.3 架构特点

1. **前后端分离**
   - 前端独立部署，可部署到CDN
   - 后端提供RESTful API
   - 通过JSON进行数据交换

2. **无状态设计**
   - 使用JWT Token进行身份验证
   - 服务器不存储会话状态
   - 便于水平扩展

3. **模块化设计**
   - 后端使用Flask Blueprint组织路由
   - 前端使用Vue组件化开发
   - 代码结构清晰，易于维护

## 3.2 模块设计

### 3.2.1 后端模块划分

```
app/
├── __init__.py          # 应用初始化
├── config.py            # 配置文件
├── models/              # 数据模型
│   ├── user.py         # 用户模型
│   ├── question.py     # 错题模型
│   └── chat.py         # AI聊天模型
├── routes/              # 路由模块
│   ├── auth.py         # 认证路由
│   ├── questions.py    # 错题路由
│   ├── subjects.py     # 科目路由
│   ├── reviews.py      # 复习路由
│   ├── exams.py        # 考试路由
│   ├── dashboard.py    # 统计路由
│   ├── profile.py      # 个人中心路由
│   ├── ai.py           # AI路由
│   └── upload.py       # 上传路由
├── services/            # 服务层
│   └── llm_client.py   # AI客户端
└── utils/               # 工具类
    └── response.py     # 响应工具
```

#### 模块职责

**models模块**：数据模型层
- 定义数据库表结构
- 提供数据操作方法
- 数据验证和转换

**routes模块**：路由层
- 处理HTTP请求
- 参数验证
- 调用模型层
- 返回响应

**services模块**：服务层
- 封装外部服务调用
- 业务逻辑处理
- 可复用的服务

**utils模块**：工具层
- 通用工具函数
- 响应格式化
- 辅助函数

### 3.2.2 前端模块划分

```
static/js/
├── apis/                # API调用模块
│   ├── auth.js         # 认证API
│   ├── question.js     # 错题API
│   ├── subject.js      # 科目API
│   ├── review.js       # 复习API
│   ├── exam.js         # 考试API
│   ├── dashboard.js    # 统计API
│   ├── profile.js      # 个人中心API
│   └── ai.js           # AI API
├── components/          # 组件模块
│   ├── common/         # 公共组件
│   │   ├── header.js   # 头部组件
│   │   └── sidebar.js  # 侧边栏组件
│   └── pages/          # 页面组件
│       ├── dashboard.js # 仪表盘
│       ├── question.js  # 错题管理
│       ├── review.js    # 复习中心
│       └── ...
├── request.js           # 请求封装
└── axios.min.js        # HTTP库
```

#### 模块职责

**apis模块**：API调用层
- 封装所有API请求
- 统一错误处理
- Token管理

**components模块**：组件层
- 可复用的Vue组件
- 页面级组件
- 公共组件

**request.js**：请求封装
- Axios实例配置
- 请求拦截器（添加Token）
- 响应拦截器（错误处理）

### 3.2.3 模块交互流程

#### 用户登录流程
```
前端 (login.html)
  ↓ 用户输入用户名密码
前端 (auth.js)
  ↓ POST /api/auth/login
后端 (routes/auth.py)
  ↓ 验证用户名密码
后端 (models/user.py)
  ↓ 查询用户
后端 (routes/auth.py)
  ↓ 生成JWT Token
前端 (auth.js)
  ↓ 保存Token到localStorage
前端 (request.js)
  ↓ 后续请求自动携带Token
```

#### 错题创建流程
```
前端 (question.js)
  ↓ 用户填写错题信息
前端 (apis/question.js)
  ↓ POST /api/questions (带Token)
后端 (routes/questions.py)
  ↓ 验证Token (before_request)
后端 (routes/questions.py)
  ↓ 验证参数
后端 (models/question.py)
  ↓ 创建Question对象
后端 (数据库)
  ↓ 保存数据
后端 (routes/questions.py)
  ↓ 返回成功响应
前端 (question.js)
  ↓ 刷新列表
```

## 3.3 数据库设计

### 3.3.1 ER图

```
┌──────────┐
│  Users   │
│──────────│
│ id (PK)  │
│ username │
│ password │
│ nickname │
│ ...      │
└────┬─────┘
     │ 1
     │
     │ N
┌────▼─────────┐      ┌──────────────┐
│  Subjects    │      │  Questions   │
│──────────────│      │──────────────│
│ id (PK)      │◄─────┤ id (PK)      │
│ user_id (FK) │  N   │ user_id (FK) │
│ name         │      │ subject_id   │
│ color        │      │ title        │
│ icon         │      │ content      │
│ ...          │      │ answer       │
└──────────────┘      │ ...          │
                      └──────┬───────┘
                             │ 1
                             │
                             │ N
                      ┌──────▼──────────┐
                      │ QuestionOptions │
                      │─────────────────│
                      │ id (PK)         │
                      │ question_id (FK)│
                      │ option_key      │
                      │ option_text     │
                      │ ...             │
                      └─────────────────┘
                             │
                             │ 1
                             │
                             │ N
                      ┌──────▼──────────┐
                      │  QuestionTags   │
                      │─────────────────│
                      │ id (PK)         │
                      │ question_id (FK)│
                      │ name            │
                      └─────────────────┘

┌──────────┐
│  Users   │
│──────────│
│ id (PK)  │
└────┬─────┘
     │ 1
     │
     │ N
┌────▼──────────┐
│ AIChatRecords │
│───────────────│
│ id (PK)       │
│ user_id (FK)  │
│ role          │
│ content       │
│ model         │
│ ...           │
└───────────────┘
```

### 3.3.2 数据表结构

#### users表（用户表）
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | VARCHAR(100) | UNIQUE, NOT NULL | 用户名 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希 |
| nickname | VARCHAR(100) | | 昵称 |
| email | VARCHAR(100) | | 邮箱 |
| phone | VARCHAR(20) | | 手机号 |
| gender | VARCHAR(10) | DEFAULT '保密' | 性别 |
| avatar | VARCHAR(255) | | 头像URL |
| bio | TEXT | | 个人简介 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

#### subjects表（科目表）
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 科目ID |
| user_id | INTEGER | FOREIGN KEY, NOT NULL | 用户ID |
| name | VARCHAR(50) | NOT NULL | 科目名称 |
| color | VARCHAR(20) | DEFAULT '#4299e1' | 颜色 |
| icon | VARCHAR(50) | DEFAULT 'fas fa-book' | 图标 |
| sort_order | INTEGER | DEFAULT 0 | 排序 |
| is_deleted | BOOLEAN | DEFAULT FALSE | 是否删除 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

#### questions表（错题表）
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 错题ID |
| user_id | INTEGER | FOREIGN KEY, NOT NULL | 用户ID |
| subject_id | INTEGER | FOREIGN KEY, NOT NULL | 科目ID |
| question_type | VARCHAR(30) | DEFAULT 'single_choice' | 题型 |
| title | VARCHAR(200) | NOT NULL | 标题 |
| content | TEXT | | 题目内容 |
| answer | TEXT | | 正确答案 |
| error_reason | TEXT | NOT NULL | 错误原因 |
| difficulty | INTEGER | DEFAULT 2 | 难度(1-3) |
| review_status | INTEGER | DEFAULT 0 | 复习状态(0-待复习,1-已复习) |
| review_count | INTEGER | DEFAULT 0 | 复习次数 |
| last_review_at | DATETIME | | 最后复习时间 |
| next_review_at | DATETIME | | 下次复习时间 |
| is_important | BOOLEAN | DEFAULT FALSE | 是否重点 |
| is_mastered | BOOLEAN | DEFAULT FALSE | 是否掌握 |
| mastery_status | VARCHAR(20) | | 掌握状态 |
| is_deleted | BOOLEAN | DEFAULT FALSE | 是否删除 |
| images | TEXT | | 图片URL列表(JSON) |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

#### question_options表（选项表）
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 选项ID |
| question_id | INTEGER | FOREIGN KEY, NOT NULL | 错题ID |
| option_key | VARCHAR(5) | NOT NULL | 选项键(A/B/C/D) |
| option_text | TEXT | NOT NULL | 选项文本 |
| is_correct | BOOLEAN | DEFAULT FALSE | 是否正确答案 |
| sort_order | INTEGER | DEFAULT 0 | 排序 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### question_tags表（标签表）
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 标签ID |
| question_id | INTEGER | FOREIGN KEY, NOT NULL | 错题ID |
| name | VARCHAR(50) | NOT NULL | 标签名称 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### ai_chat_records表（AI聊天记录表）
| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 记录ID |
| user_id | INTEGER | FOREIGN KEY, NOT NULL | 用户ID |
| role | VARCHAR(20) | NOT NULL | 角色(user/assistant) |
| content | TEXT | NOT NULL | 消息内容 |
| model | VARCHAR(64) | | 使用的模型 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 3.3.3 数据库关系说明

1. **用户-科目关系**：一对多，一个用户可以有多个科目
2. **用户-错题关系**：一对多，一个用户可以有多个错题
3. **科目-错题关系**：一对多，一个科目可以有多个错题
4. **错题-选项关系**：一对多，一个错题可以有多个选项
5. **错题-标签关系**：一对多，一个错题可以有多个标签
6. **用户-AI聊天记录关系**：一对多，一个用户可以有多个聊天记录

### 3.3.4 索引设计

- `users.username`：唯一索引，加速登录查询
- `subjects.user_id`：普通索引，加速用户科目查询
- `questions.user_id`：普通索引，加速用户错题查询
- `questions.subject_id`：普通索引，加速科目错题查询
- `questions.review_status`：普通索引，加速复习查询
- `ai_chat_records.user_id`：普通索引，加速聊天记录查询

## 3.4 UI/UX设计

### 3.4.1 设计原则

1. **简洁明了**：界面简洁，信息层次清晰
2. **一致性**：使用Element UI保证组件风格一致
3. **易用性**：操作流程简单，关键功能不超过3步
4. **响应式**：支持不同屏幕尺寸
5. **可访问性**：支持键盘操作，提供清晰的视觉反馈

### 3.4.2 页面结构

#### 整体布局
```
┌─────────────────────────────────────┐
│  Header (头部)                       │
│  - Logo/标题                         │
│  - 用户信息/退出                      │
├──────────┬──────────────────────────┤
│          │                          │
│ Sidebar  │  Main Content            │
│ (侧边栏)  │  (主内容区)               │
│          │                          │
│ - 仪表盘  │  - 页面标题               │
│ - 错题管理 │  - 功能内容              │
│ - 复习中心 │  - 数据表格/表单         │
│ - 出卷自测 │  - 图表/统计             │
│ - AI助手  │                          │
│ - 数据统计 │                          │
│ - 个人中心 │                          │
│          │                          │
└──────────┴──────────────────────────┘
```

#### 页面列表

1. **登录页** (`login.html`)
   - 用户名输入框
   - 密码输入框
   - 登录按钮
   - 注册链接

2. **注册页** (`register.html`)
   - 用户名输入框
   - 密码输入框
   - 确认密码输入框
   - 注册按钮
   - 返回登录链接

3. **仪表盘** (`dashboard.html`)
   - 统计卡片（总错题数、科目数、已复习、待复习等）
   - 错题分类分布饼图
   - 复习趋势折线图
   - 掌握状态柱状图

4. **错题管理** (`question.html`)
   - 筛选栏（关键词、科目、难度、题型）
   - 错题列表表格
   - 添加/编辑错题对话框
   - 错题详情对话框

5. **复习中心** (`review.html`)
   - 复习统计卡片
   - 复习模式选择
   - 复习题目列表
   - 复习结果提交

6. **出卷自测** (`exam.html`)
   - 试卷生成表单
   - 答题界面
   - 结果展示

7. **AI助手** (`ai-solve.html`)
   - 聊天界面
   - 消息输入框
   - 历史记录

8. **数据统计** (`statistics.html`)
   - 各类统计图表
   - 数据明细表格

9. **个人中心** (`profile.html`)
   - 个人资料表单
   - 头像上传
   - 密码修改

### 3.4.3 交互设计

#### 关键交互流程

**错题添加流程**
1. 点击"添加错题"按钮
2. 弹出对话框
3. 填写错题信息（标题、科目、题型、难度、内容、答案、错误原因）
4. 可选：添加选项、标签、图片
5. 点击"保存"按钮
6. 显示成功提示
7. 自动刷新列表

**复习流程**
1. 进入复习中心
2. 选择复习模式（待复习/随机/重点/按难度）
3. 系统显示题目列表
4. 点击题目开始复习
5. 查看题目和答案
6. 选择复习结果（忘记/有点难/已掌握）
7. 提交结果
8. 自动更新复习状态

**AI对话流程**
1. 进入AI助手页面
2. 输入问题
3. 点击发送
4. AI回复流式显示
5. 继续对话
6. 查看历史记录

### 3.4.4 视觉设计

#### 颜色方案
- **主色调**：蓝色系（#4299e1）
- **成功色**：绿色（#48bb78）
- **警告色**：橙色（#ed8936）
- **错误色**：红色（#f56565）
- **背景色**：浅灰色（#f7fafc）

#### 字体
- **中文字体**：系统默认（微软雅黑/苹方）
- **英文字体**：系统默认（Arial/Helvetica）
- **代码字体**：Monaco/Courier New

#### 图标
- 使用Font Awesome图标库
- 科目图标可自定义

---

**文档版本**：v1.0  
**创建日期**：2025-12-02  
**最后更新**：2025-12-02

