<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>错题管理系统 - 登录</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
    <link rel="stylesheet" href="/static/css/base.css" />
    <link rel="stylesheet" href="/static/css/auth.css" />
  </head>
  <body>
    <!-- 页面装饰元素 -->
    <div class="decor decor1"></div>
    <div class="decor decor2"></div>
    <div class="decor decor3"></div>

    <div id="app" class="auth-wrapper">
      <div class="auth-layout">
        <!-- 左侧背景区 -->
        <div class="auth-left">
          <div class="left-content">
            <h2 class="left-title">初三数学错题管理系统</h2>
            <p class="left-desc">智能管理错题，精准提升成绩，让每一次复习都更有价值</p>
          </div>
        </div>

        <!-- 右侧登录区 -->
        <div class="auth-right">
          <div class="right-decor"></div>

          <div class="login-header">
            <h3 class="login-title">欢迎登录</h3>
          </div>

          <el-form :model="loginForm" :rules="rules" ref="loginFormRef" label-width="0">
            <el-form-item prop="username">
              <label class="form-label">账号</label>
              <el-input
                v-model="loginForm.username"
                placeholder="输入账号"
              ></el-input>
            </el-form-item>

            <el-form-item prop="password">
              <label class="form-label">密码</label>
              <el-input
                v-model="loginForm.password"
                show-password
                placeholder="请输入密码"
              ></el-input>
            </el-form-item>

            <div class="form-actions">
              <el-checkbox v-model="loginForm.remember" size="mini">记住密码</el-checkbox>
              <el-button type="text" size="mini" style="color: #4299e1;">忘记密码？</el-button>
            </div>

            <el-button
              type="primary"
              class="login-button"
              :loading="loading"
              @click="handleLogin"
              style="background: #4299e1; border-color: #4299e1;"
            >
              登录
            </el-button>

            <div class="register-link">
              <el-button type="text" @click="goRegister">
                没有账号？立即注册
              </el-button>
            </div>
          </el-form>
        </div>
      </div>
    </div>

    <script src="/static/js/axios.min.js"></script>
    <script src="/static/js/vue.js"></script>
    <script src="/static/js/element-ui.js"></script>
    <script src="/static/js/request.js"></script>
    <script src="/static/js/apis/auth.js"></script>
    <script>
      new Vue({
        el: "#app",
        data() {
          return {
            loginForm: {
              username: "",
              password: "",
              remember: false,
            },
            loading: false
          };
        },
        computed: {
          rules() {
            const vm = this;
            return {
              username: [
                { required: true, message: '请输入账号', trigger: 'blur' }
              ],
              password: [
                { required: true, message: '请输入密码', trigger: 'blur' }
              ]
            };
          }
        },
        mounted() {
          // 页面加载时，检查是否有保存的密码
          this.loadRememberedPassword();
        },
        methods: {
          // 加载记住的密码
          loadRememberedPassword() {
            const rememberedUsername = localStorage.getItem('remembered_username');
            const rememberedPassword = localStorage.getItem('remembered_password');
            
            if (rememberedUsername && rememberedPassword) {
              try {
                // 使用 base64 解码密码
                const decodedPassword = atob(rememberedPassword);
                this.loginForm.username = rememberedUsername;
                this.loginForm.password = decodedPassword;
                this.loginForm.remember = true;
              } catch (error) {
                console.error('加载记住的密码失败:', error);
                // 如果解码失败，清除无效数据
                this.clearRememberedPassword();
              }
            }
          },
          // 保存记住的密码
          saveRememberedPassword() {
            if (this.loginForm.remember) {
              // 使用 base64 编码密码（简单加密）
              const encodedPassword = btoa(this.loginForm.password);
              localStorage.setItem('remembered_username', this.loginForm.username);
              localStorage.setItem('remembered_password', encodedPassword);
            } else {
              // 如果取消勾选，清除保存的密码
              this.clearRememberedPassword();
            }
          },
          // 清除记住的密码
          clearRememberedPassword() {
            localStorage.removeItem('remembered_username');
            localStorage.removeItem('remembered_password');
          },
          async handleLogin() {
            this.$refs.loginFormRef.validate(async (valid) => {
              if (!valid) {
                return false;
              }
              this.loading = true;
              try {
                const result = await authAPI.login({
                  username: this.loginForm.username,
                  password: this.loginForm.password
                });
                const { token, user_info } = result.data;
                localStorage.setItem('token', token);
                localStorage.setItem('user_info', JSON.stringify(user_info));
                
                // 根据记住密码选项保存或清除密码
                this.saveRememberedPassword();
                
                this.$message.success(result.message || '登录成功');
                setTimeout(() => {
                  window.location.href = "/dashboard";
                }, 800);
              } catch (error) {
                const message = error.message || '登录失败，请稍后再试';
                this.$message.error(message);
              } finally {
                this.loading = false;
              }
            });
          },
          goRegister() {
            window.location.href = "/register";
          }
        }
      });
    </script>
  </body>
</html>